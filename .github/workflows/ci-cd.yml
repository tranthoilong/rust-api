name: CI/CD Pipeline (Rust API)

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

env:
  DOCKER_IMAGE_NAME: longdevlor/rust-api
  DOCKER_REGISTRY: docker.io
  CARGO_TERM_COLOR: always

jobs:
  # ============================================================
  # Job 1: Code Quality Check
  # ============================================================
  code-quality:
    name: Code Quality Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy,rustfmt

      - name: Cache Cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Check code formatting (rustfmt)
        run: |
          echo "Checking Rust formatting with rustfmt..."
          cargo fmt --all -- --check

      - name: Run Clippy (linter)
        run: |
          echo "Running Clippy..."
          cargo clippy --all-targets --all-features -- -D warnings

      - name: Build (debug)
        run: |
          echo "Building project..."
          cargo build --all-features

      - name: Code quality summary
        if: success()
        run: |
          echo "‚úÖ All code quality checks passed!"
          echo "‚úì Formatting (rustfmt)"
          echo "‚úì Linting (Clippy)"
          echo "‚úì Build (cargo build)"

      - name: Send Telegram notification on failure
        if: failure()
        continue-on-error: true
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_TO }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: |
            ‚ùå Code Quality Check FAILED!

            üì¶ Project: ${{ env.DOCKER_IMAGE_NAME }}
            üåø Branch: ${{ github.ref }}
            üë§ Author: ${{ github.actor }}
            üìù Commit: ${{ github.event.head_commit.message }}

            ‚ö†Ô∏è Failed Step: Code Quality Check (Rust)

            Possible issues:
            ‚Ä¢ Code formatting (rustfmt)
            ‚Ä¢ Linting errors (Clippy)
            ‚Ä¢ Build errors

            üîó View Details: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

            üí° Fix the issues and push l·∫°i!

  # ============================================================
  # Job 2: Run Tests
  # ============================================================
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: code-quality

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: rust_api_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Install Postgres client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Run database migrations
        env:
          DATABASE_URL: postgres://postgres:postgres@localhost:5432/rust_api_test
        run: |
          echo "Running database migrations..."
          chmod +x ./init_db.sh
          ./init_db.sh

      - name: Run tests
        env:
          DATABASE_URL: postgres://postgres:postgres@localhost:5432/rust_api_test
          RUST_LOG: debug
        run: |
          echo "Running test suite..."
          cargo test --all --all-features

      - name: Build application (release)
        run: |
          echo "Building release binary..."
          cargo build --release --all-features

  # ============================================================
  # Job 3: Build and Push Docker Image
  # ============================================================
  build-and-push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Extract metadata (tags, labels)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Docker image
        id: build-push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=registry,ref=${{ env.DOCKER_IMAGE_NAME }}:buildcache
          cache-to: type=registry,ref=${{ env.DOCKER_IMAGE_NAME }}:buildcache,mode=max
          platforms: linux/amd64

      - name: Image digest
        run: |
          echo "Image digest: ${{ steps.build-push.outputs.digest }}"

  # ============================================================
  # Job 4: Deploy to Production Server
  # ============================================================
  deploy:
    name: Deploy to Production Server
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Deploy to server via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          script: |
            set -e

            APP_DIR="${{ secrets.APP_DIRECTORY || '/opt/rust-api' }}"
            CONTAINER_NAME="rust-api"
            NETWORK_NAME="rust-api-network"

            # Ensure application directory exists
            if [ ! -d "$APP_DIR" ]; then
              echo "Creating directory: $APP_DIR"
              mkdir -p "$APP_DIR"
            fi
            cd "$APP_DIR"

            # Create network if it doesn't exist
            if ! docker network inspect "$NETWORK_NAME" >/dev/null 2>&1; then
              echo "Creating Docker network: $NETWORK_NAME"
              docker network create "$NETWORK_NAME"
            fi

            # Pull latest Docker image
            echo "Pulling latest Docker image..."
            docker pull ${{ env.DOCKER_IMAGE_NAME }}:latest

            # Stop and remove old container
            echo "Stopping old container..."
            docker stop "$CONTAINER_NAME" || true
            docker rm "$CONTAINER_NAME" || true

            # Run new container (∆∞u ti√™n d√πng .env tr√™n server)
            if [ -f .env ]; then
              echo "‚úÖ Found .env file, using it for deployment."
              docker run -d \
                --name "$CONTAINER_NAME" \
                --restart unless-stopped \
                --network "$NETWORK_NAME" \
                -p ${{ secrets.APP_PORT || 4000 }}:4000 \
                --env-file .env \
                ${{ env.DOCKER_IMAGE_NAME }}:latest
            else
              echo "‚ö†Ô∏è .env file not found. Please configure environment variables via Docker or update this script."
              docker run -d \
                --name "$CONTAINER_NAME" \
                --restart unless-stopped \
                --network "$NETWORK_NAME" \
                -p ${{ secrets.APP_PORT || 4000 }}:4000 \
                ${{ env.DOCKER_IMAGE_NAME }}:latest
            fi

            # Wait for container to be healthy
            echo "Waiting for container to start..."
            sleep 10

            # Check container status
            if docker ps | grep -q "$CONTAINER_NAME"; then
              echo "‚úÖ Container is running."
              docker ps | grep "$CONTAINER_NAME"
            else
              echo "‚ùå Container failed to start."
              docker logs --tail 50 "$CONTAINER_NAME" || true
              exit 1
            fi

            # Show logs
            echo "Container logs (last 50 lines):"
            docker logs --tail 50 "$CONTAINER_NAME" || true

            # Cleanup old images
            echo "Cleaning up old images..."
            docker image prune -f

      - name: Verify deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          script: |
            CONTAINER_NAME="rust-api"
            if docker ps | grep -q "$CONTAINER_NAME"; then
              echo "‚úÖ Deployment successful! Container is running."
              docker ps | grep "$CONTAINER_NAME"
            else
              echo "‚ùå Deployment failed! Container is not running."
              docker logs "$CONTAINER_NAME" || true
              exit 1
            fi

  # ============================================================
  # Job 5: Deploy to Staging (develop)
  # ============================================================
  deploy-staging:
    name: Deploy to Staging Server
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.event_name == 'push' && github.ref == 'refs/heads/develop'

    steps:
      - name: Deploy to staging server via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.STAGING_SERVER_HOST }}
          username: ${{ secrets.STAGING_SERVER_USER }}
          key: ${{ secrets.STAGING_SERVER_SSH_KEY }}
          port: ${{ secrets.STAGING_SERVER_PORT || 22 }}
          script: |
            set -e

            APP_DIR="${{ secrets.STAGING_APP_DIRECTORY || '/opt/rust-api-staging' }}"
            CONTAINER_NAME="rust-api-staging"
            NETWORK_NAME="rust-api-network"

            # Ensure application directory exists
            if [ ! -d "$APP_DIR" ]; then
              echo "Creating directory: $APP_DIR"
              mkdir -p "$APP_DIR"
            fi
            cd "$APP_DIR"

            # Create network if it doesn't exist
            if ! docker network inspect "$NETWORK_NAME" >/dev/null 2>&1; then
              echo "Creating Docker network: $NETWORK_NAME"
              docker network create "$NETWORK_NAME"
            fi

            # Pull latest Docker image for develop tag
            echo "Pulling latest Docker image for develop..."
            docker pull ${{ env.DOCKER_IMAGE_NAME }}:develop

            # Stop and remove old container
            echo "Stopping old container..."
            docker stop "$CONTAINER_NAME" || true
            docker rm "$CONTAINER_NAME" || true

            # Run new container (s·ª≠ d·ª•ng .env.staging n·∫øu c√≥)
            if [ -f .env.staging ]; then
              echo "‚úÖ Found .env.staging, using it for staging deployment."
              docker run -d \
                --name "$CONTAINER_NAME" \
                --restart unless-stopped \
                --network "$NETWORK_NAME" \
                -p 4001:4000 \
                --env-file .env.staging \
                ${{ env.DOCKER_IMAGE_NAME }}:develop
            else
              echo "‚ö†Ô∏è .env.staging file not found. Please configure it for staging environment."
              docker run -d \
                --name "$CONTAINER_NAME" \
                --restart unless-stopped \
                --network "$NETWORK_NAME" \
                -p 4001:4000 \
                ${{ env.DOCKER_IMAGE_NAME }}:develop
            fi

            # Wait for container to be healthy
            echo "Waiting for container to start..."
            sleep 10

            # Check container status
            if docker ps | grep -q "$CONTAINER_NAME"; then
              echo "‚úÖ Staging container is running."
              docker ps | grep "$CONTAINER_NAME"
            else
              echo "‚ùå Staging container failed to start."
              docker logs --tail 50 "$CONTAINER_NAME" || true
              exit 1
            fi

            # Cleanup old images
            echo "Cleaning up old images..."
            docker image prune -f

  # ============================================================
  # Job 6: Notify
  # ============================================================
  notify:
    name: Send Notification
    runs-on: ubuntu-latest
    needs: [deploy, deploy-staging]
    if: always()
    env:
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
      TELEGRAM_TO: ${{ secrets.TELEGRAM_TO }}

    steps:
      - name: Send Slack notification
        if: env.SLACK_WEBHOOK_URL != ''
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: |
            Deployment Status: ${{ job.status }}
            Branch: ${{ github.ref }}
            Commit: ${{ github.sha }}
            Author: ${{ github.actor }}
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Send Telegram notification
        if: env.TELEGRAM_TOKEN != '' && env.TELEGRAM_TO != ''
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_TO }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: |
            üöÄ Deployment Status: ${{ job.status }}

            üì¶ Project: ${{ env.DOCKER_IMAGE_NAME }}
            üåø Branch: ${{ github.ref }}
            üë§ Author: ${{ github.actor }}
            üìù Commit: ${{ github.event.head_commit.message }}

            üîó View Run: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
